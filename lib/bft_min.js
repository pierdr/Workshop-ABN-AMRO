function isNumber(a){return!isNaN(parseFloat(a))}function get_appropriate_ws_url(a){var b,c=document.URL;"https"==c.substring(0,5)?(b="ws://",c=c.substr(8)):(b="ws://","http"==c.substring(0,4)&&(c=c.substr(7))),c=c.split("/");var d="";return d=""==a?c[0]:a,b+d}function clamp(a,b,c){return a<b?a=b:a>c?a=c:a}var BrowserDetect;try{BrowserDetect={init:function(){try{this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"}catch(a){this.browser="none",this.version="none",this.OS="none"}},searchString:function(a){for(var b=0;b<a.length;b++){var c=a[b].string,d=a[b].prop;if(this.versionSearchString=a[b].versionSearch||a[b].identity,c){if(c.indexOf(a[b].subString)!=-1)return a[b].identity}else if(d)return a[b].identity}},searchVersion:function(a){var b=a.indexOf(this.versionSearchString);if(b!=-1)return parseFloat(a.substring(b+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]}}catch(e){BrowserDetect={init:function(){try{this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"}catch(a){this.browser="none",this.version="none",this.OS="none"}}}}BrowserDetect.init();var pos=0;String.prototype.replaceAll=function(a,b){var c=this;return c.replace(new RegExp(a,"g"),b)},!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.ReconnectingWebSocket=b()}(this,function(){function a(b,c,d){function e(a,b){var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,!1,!1,b),c}var f={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};d||(d={});for(var g in f)this[g]="undefined"!=typeof d[g]?d[g]:f[g];this.url=b,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var h,i=this,j=!1,k=!1,l=document.createElement("div");l.addEventListener("open",function(a){i.onopen(a)}),l.addEventListener("close",function(a){i.onclose(a)}),l.addEventListener("connecting",function(a){i.onconnecting(a)}),l.addEventListener("message",function(a){i.onmessage(a)}),l.addEventListener("error",function(a){i.onerror(a)}),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),this.open=function(b){h=new WebSocket(i.url,c||[]),b||l.dispatchEvent(e("connecting")),(i.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",i.url);var d=h,f=setTimeout(function(){(i.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",i.url),k=!0,d.close(),k=!1},i.timeoutInterval);h.onopen=function(){clearTimeout(f),(i.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onopen",i.url),i.protocol=h.protocol,i.readyState=WebSocket.OPEN,i.reconnectAttempts=0;var c=e("open");c.isReconnect=b,b=!1,l.dispatchEvent(c)},h.onclose=function(c){if(clearTimeout(f),h=null,j)i.readyState=WebSocket.CLOSED,l.dispatchEvent(e("close"));else{i.readyState=WebSocket.CONNECTING;var d=e("connecting");d.code=c.code,d.reason=c.reason,d.wasClean=c.wasClean,l.dispatchEvent(d),b||k||((i.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onclose",i.url),l.dispatchEvent(e("close")));var f=i.reconnectInterval*Math.pow(i.reconnectDecay,i.reconnectAttempts);setTimeout(function(){i.reconnectAttempts++,i.open(!0)},f>i.maxReconnectInterval?i.maxReconnectInterval:f)}},h.onmessage=function(b){(i.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",i.url,b.data);var c=e("message");c.data=b.data,l.dispatchEvent(c)},h.onerror=function(b){(i.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onerror",i.url,b),l.dispatchEvent(e("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(b){if(h)return(i.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","send",i.url,b),h.send(b);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(a,b){"undefined"==typeof a&&(a=1e3),j=!0,h&&h.close(a,b)},this.refresh=function(){h&&h.close()}}return a.prototype.onopen=function(){},a.prototype.onclose=function(){},a.prototype.onconnecting=function(){},a.prototype.onmessage=function(){},a.prototype.onerror=function(){},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a}),window.BFt={},BFt.state="INIT",BFt.changedStateInCycle=0,BFt.changeState=function(a){a!=BFt.state&&(BFt.state=a,BFt.changedStateInCycle=1,jQuery.event.trigger("stateChanged",{}))},window.onbeforeunload=function(){for(var a in BFt)BFt[a].socket.close(16,"page closing")},window.BFtObject=function(){var a=new Object;return a.socket=new Object,a.status="INIT",a.subscribed={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0,pir:0},a.callbacks={videoended:0,socketopen:0,distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0,pir:0},a.subscribeFunctions={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0,pir:0},a.setupSocket=a.start=function(b,c){if(""==b)return void(b="192.168.1.:9092");b.indexOf(":")==-1&&(b+=":9092"),"Firefox"==BrowserDetect.browser?console.error("Websocket not supported. Please use Safari or Chrome."):a.socket=new ReconnectingWebSocket(get_appropriate_ws_url(b)),void 0!=c&&(a.callbacks.socketopen=c);try{a.socket.onopen=function(){a.status="OPEN",jQuery.event.trigger("socketOpened",[]),a.retrial=0;for(var b in a.subscribed)a.subscribed[b]&&a.subscribeFunctions[b]();0!=a.callbacks.socketopen&&a.callbacks.socketopen();try{socketOpened()}catch(c){}},a.socket.onmessage=function(b){try{messageObject=JSON.parse(b.data)}catch(c){console.warn("error loading JSON",b,c)}var d=a.socket.url.replace(a.socket.url.slice(-5),"");if(d=d.slice(5),"x"==messageObject.m||"xm"==messageObject.m||"xt"==messageObject.m)return void jQuery.event.trigger("ping",{address:d,type:messageObject.m});if(console.info('::: ----> received:"'+messageObject.m+'"',messageObject),"touched"!=messageObject.m)if("a"==messageObject.m)jQuery.event.trigger("a",{address:d,r:messageObject.r,y:messageObject.y,p:messageObject.p}),0!=a.callbacks.attitude&&a.callbacks.attitude(d,{r:messageObject.r,y:messageObject.y,p:messageObject.p});else if("oom"==messageObject.m)jQuery.event.trigger("oom",{address:d});else if("rx"==messageObject.m)jQuery.event.trigger("receivedRx",{address:d,v:messageObject.v}),0!=a.callbacks.rxembedded&&a.callbacks.rxembedded(d,messageObject.v);else if("pir"==messageObject.m)jQuery.event.trigger("pir",{address:d}),0!=a.callbacks.pir&&a.callbacks.pir(d);else if("orientationChanged"==messageObject.m){a.orientation=messageObject.value,0!=a.callbacks.orientation&&a.callbacks.orientation(d,a.orientation);try{orientationChanged(d,a.orientation)}catch(c){}jQuery.event.trigger("orientationChanged",{address:d,value:messageObject.value})}else if("magnetometerUpdate"==messageObject.m){a.magnetometer=messageObject.t,a.magnetometerIntensity=messageObject.i,0!=a.callbacks.magnetometer&&a.callbacks.magnetometer(d,a.magnetometer,a.magnetometerIntensity);try{magnetometerEvent(d,a.magnetometer,a.magnetometerIntensity)}catch(c){}jQuery.event.trigger("magnetometerEvent",{address:d,i:messageObject.i,t:messageObject.t})}else if("distanceChanged"==messageObject.m){a.proximity=messageObject.proximity,0!=a.callbacks.distance&&a.callbacks.distance(d,a.proximity);try{distanceChanged(d,a.proximity)}catch(c){}jQuery.event.trigger("distanceChanged",{address:d,p:messageObject.proximity})}else if("audioJackChanged"==messageObject.m){a.audiojack=messageObject["in"],0!=a.callbacks.audiojack&&a.callbacks.audiojack(d,a.audiojack);try{audioJackChanged(d,a.audiojack)}catch(c){}jQuery.event.trigger("audioJackChanged",{address:d,"in":messageObject["in"]})}else if("powerSourceChanged"==messageObject.m){a.powersource=messageObject.source,0!=a.callbacks.powersource&&a.callbacks.powersource(d,a.powersource);try{powerSourceChanged(d,a.powersource)}catch(c){}jQuery.event.trigger("powerSourceChanged",{address:d,"in":messageObject.source})}else if("batteryGet"==messageObject.m){a.batteryLevel=messageObject.value;try{gotBatteryLevel(messageObject.value)}catch(c){}jQuery.event.trigger("gotBatteryLevel",{address:d,batteryLevel:messageObject.value})}else if("videoEnded"==messageObject.m){0!=a.callbacks.videoended&&a.callbacks.videoended(d);try{videoEnded()}catch(c){}jQuery.event.trigger("videoEnded",{address:d})}else"error"==messageObject.m?console.warn(messageObject.type):"test"==messageObject.m&&console.log(Date.now());else{0!=messageObject.value&&"0"!=messageObject.value||(a.touched=!1),0!=a.callbacks.touched?a.callbacks.touched(d,{x:messageObject.x,y:messageObject.y}):(a.touched=!0,jQuery.event.trigger("touched",{address:d,x:messageObject.x,y:messageObject.y}));try{touched(d,messageObject.x,messageObject.y)}catch(c){}}},a.socket.onclose=function(){a.status="CLOSED",console.warn("connection: %s",a.status,a.socket)},a.socket.onerror=function(){a.status="ERROR"}}catch(d){alert("<p>Error"+d),a.status="ERROR"}},a.setServoEmbedded=function(a,b){2==arguments.length&&this.sendMessage('{"m":"srv","n":'+a+',"v":'+b+"}")},a.setRelayEmbedded=function(a,b){2==arguments.length&&this.sendMessage('{"m":"rel","n":'+a+',"v":'+Math.round(b)+"}")},a.sendSerialMessageEmbedded=function(a){1==arguments.length&&this.sendMessage('{"m":"tx","v":"'+a+'"}')},a.setColorEmbedded=function(a,b,c,d){5!=arguments.length&&4!=arguments.length||this.sendMessage('{"m":"col","n":"'+a+'","r":"'+Math.floor(b)+'","g":"'+Math.floor(c)+'","b":"'+Math.floor(d)+'"}')},a.blinkColorEmbedded=function(a,b,c,d){4==arguments.length&&this.sendMessage('{"m":"blk","n":"'+a+'","r":"'+Math.floor(b)+'","g":"'+Math.floor(c)+'","b":"'+Math.floor(d)+'"}')},a.setAllColorEmbedded=function(a,b,c){3==arguments.length&&this.sendMessage('{"m":"all","r":"'+Math.floor(a)+'","g":"'+Math.floor(b)+'","b":"'+Math.floor(c)+'"}')},a.setColor=function(a,b,c,d){if(4==arguments.length&&((a>1||b>1||c>1)&&(a/=255,b/=255,c/=255,d/=255),this.sendMessage('{"m":"setColor","r":"'+a+'","g":"'+b+'","b":"'+c+'","a":"'+d+'"}')),1==arguments.length&&arguments[0].hasOwnProperty(r)){var e=a;(e.r>1||e.g>1||e.b>1)&&(e.r=e.r/255,e.g=e.g/255,e.b=e.b/255,e.a=e.a/255),this.sendMessage('{"m":"setColor","r":"'+e.r+'","g":"'+e.g+'","b":"'+e.b+'","a":"'+e.a+'"}')}},a.setFlashLight=function(a){a=clamp(a,0,a),this.sendMessage('{"m":"setLED","value":"1","in":"'+a+'"}')},a.pulseFlashLight=function(a,b,c){3==arguments.length?this.sendMessage('{"m":"pulseLED","t":"'+a+'","d":"'+b+'","i":"'+c+'"}'):console.warn("pulseLED requires 3 inputs: numberOfPulses,duration,intensity")},a.showImage=function(a){"string"==typeof a?this.sendMessage('{"m":"showImage","url":"'+a+'"}'):console.warn("showImage requires a string input")},a.playVideo=function(b,c){void 0!=c?a.callbacks.videoended=c:a.callbacks.videoended=0,"string"==typeof b?this.sendMessage('{"m":"playVideo","url":"'+b+'"}'):console.warn("playVideo requires a string input")},a.playAudio=function(a){"string"==typeof a?this.sendMessage('{"m":"playAudio","url":"'+a+'"}'):console.warn("playAudio requires a string input")},a.setBrightness=function(a){isNumber(a)?this.sendMessage('{"m":"setBrightness","b":"'+a+'"}'):console.warn("setBrighness requires one numerical parameter")},a.takePicture=function(a,b){if(arguments.length>0&&isNumber(a)){var c='{"m":"takePicture","c":"'+a+'"';arguments.length>1&&"ui"==b&&(c+=',"i":"ui"'),c+="}",this.sendMessage(c)}else this.sendMessage('{"m":"takePicture"}')},a.transitionColors=function(a,b,c){3==arguments.length?(isNumber(c)||(c=5,console.warn("transitionColors: duration is not a number")),this.sendMessage('{"m":"transitionColors","r1":"'+a.r+'","g1":"'+a.b+'","b1":"'+a.g+'","a1":"'+a.a+'","r2":"'+b.r+'","g2":"'+b.g+'","b2":"'+b.b+'","a2":"'+b.a+'","duration":"'+c+'"}')):console.warn("transitionColors requires 3 parameters: color1,color2,duration")},a.getBatteryLevel=function(){var b='{"m":"getBattery"}';a.sendMessage(b)},a.subscribeFunctions.distance=a.subscribeDistance=function(b){a.subscribed.distance=1,a.sendMessage('{"m":"registerDistance"}'),void 0!=b?a.callbacks.distance=b:a.callbacks.distance=0},a.releaseDistance=function(){a.subscribed.distance=0,a.sendMessage('{"m":"releaseDistance"}')},a.subscribeFunctions.touch=a.subscribeTouch=function(b){a.subscribed.touch=1,a.sendMessage('{"m":"registerTouch"}'),void 0!=b?a.callbacks.touch=b:a.callbacks.touch=0},a.releaseTouch=function(){a.subscribed.touch=0,a.sendMessage('{"m":"releaseTouch"}')},a.subscribeFunctions.attitude=a.subscribeAttitude=function(b,c){a.subscribed.attitude=1,a.sendMessage('{"m":"registerAttitude","f":"'+b+'"}'),void 0!=c?a.callbacks.attitude=c:a.callbacks.attitude=0},a.releaseAttitude=function(b){a.subscribed.attitude=0,a.sendMessage('{"m":"releaseAttitude"}')},a.subscribeFunctions.audiojack=a.subscribeAudioJack=function(b){a.subscribed.audiojack=1,a.sendMessage('{"m":"registerAudioJack"}'),void 0!=b?a.callbacks.audiojack=b:a.callbacks.audiojack=0},a.releaseAudioJack=function(){a.subscribed.audiojack=0,a.sendMessage('{"m":"releaseAudioJack"}')},a.subscribeFunctions.powersource=a.subscribePowerSource=function(b){a.subscribed.powersource=1,a.sendMessage('{"m":"registerPowerSource"}'),void 0!=b?a.callbacks.powersource=b:a.callbacks.powersource=0},a.releasePowerSource=function(){a.subscribed.powersource=0,a.sendMessage('{"m":"releasePowerSource"}')},a.subscribeFunctions.magnetometer=a.subscribeMagnetometer=function(b){a.subscribed.magnetometer=1,a.sendMessage('{"m":"registerMagnetometer"}'),void 0!=b?a.callbacks.magnetometer=b:a.callbacks.magnetometer=0},a.releaseMagnetometer=function(){a.subscribed.magnetometer=0,a.sendMessage('{"m":"releaseMagnetometer"}')},a.subscribeFunctions.orientation=a.subscribeOrientation=function(b){a.subscribed.orientation=1;var c='{"m":"registerOrientation"}';a.sendMessage(c),void 0!=b?a.callbacks.orientation=b:a.callbacks.orientation=0},a.releaseOrientation=function(){var b='{"m":"releaseOrientation"}';a.subscribed.orientation=0,a.sendMessage(b)},a.subscribeFunctions.rxembedded=a.subscribeRxEmbedded=function(b){var c='{"m":"srx"}';a.subscribed.rxembedded=1,a.sendMessage(c),void 0!=b?a.callbacks.rxembedded=b:a.callbacks.rxembedded=0},a.releaseRxEmbedded=function(){a.subscribed.rxembedded=0,a.sendMessage('{"m":"drx"}')},a.subscribeFunctions.pir=a.subscribePir=function(b){var c='{"m":"spir"}';a.subscribed.pir=1,a.sendMessage(c),void 0!=b?a.callbacks.pir=b:a.callbacks.pir=0},a.releasePir=function(){a.subscribed.pir=0,a.sendMessage('{"m":"dpir"}')},a.makeVibrate=function(b){var c;c=""!=b&&void 0!=b&&""!=b?'{"m":"makeVibrate","duration":"'+b+'"}':'{"m":"makeVibrate"}',a.sendMessage(c)},a.sendMessage=function(b){try{a.socket.send(b),a.retrial=0}catch(c){a.retrial<3?(a.socket.refresh(),a.retrial++,setTimeout(function(){a.sendMessage(b)},100)):console.warn("communication error: "+c)}},a};